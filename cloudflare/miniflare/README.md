# ðŸ”¥ Miniflare local testing with WPT

Miniflare is a simulator for developing and testing Cloudflare Workers. It's written in TypeScript, and runs your code in a sandbox implementing Workers' runtime APIs.

## Step 1

Run local WPT. [For example the Pi version](docs/wpt-local-raspberrypi.md).

## Step 2

Run miniflare with the worker.js file provided (make any change you need to it beofre or use the provided recipes)

```bash
cd cloudflare/miniflare
npx miniflare worker.js --https --watch --debug
```

This will run miniflare and will create a HTTPS server. In the same folder a `.mf` folder will appear with the ssl certificate created.
You can copy the cert file on the WPT agent machine and enable it and use it.

For Ubuntu to add a new certificate:

```bash
# From here: https://ubuntu.com/server/docs/security-trust-store
# Unless you did this
sudo apt-get install -y ca-certificates

# Copy the CRT file with the cert generated by Miniflare (cert.pem needs to be renamed to cert.crt)
sudo cp local-ca.crt /usr/local/share/ca-certificates
sudo update-ca-certificates

# To remove it, just delete the file and run again.
```

The CA trust store as generated by update-ca-certificates is available at the following locations:

* As a single file (PEM bundle) in /etc/ssl/certs/ca-certificates.crt
* As an OpenSSL compatible certificate directory in /etc/ssl/certs

## Step 3

Run a WPT test but proxy the request via the newly created miniflare worker server.

Make sure the following are set:

- In the `Advanced` tab check `Save response bodies`
- In the `Script` tab add the following:

```
overrideHost	www.example.com	192.168.0.150:8787
setCookie	https://www.example.com	wpt-experiments=raduCustom
navigate	%URL%
```

> 192.168.0.150:8787 is the IP provided by running miniflare

And run the test.

For better comparison run a control test using the same proxy:

```
overrideHost	www.example.com	192.168.0.150:8787
navigate	%URL%
```